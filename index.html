<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calidus Key Authentication</title>
</head>
<body>
<h1>Calidus Key Authentication</h1>

<!-- Request Nonce Section -->
<div>
    <h2>Step 1: Request Authentication</h2>
    <label>Pool ID (if applicable):</label><br>
    <input type="text" id="poolId" placeholder="Enter Pool ID"><br><br>

    <label>Calidus Key (if applicable):</label><br>
    <input type="text" id="calidusKey" placeholder="Enter Calidus Key"><br><br>

    <button onclick="requestAuth()">Request Authentication</button>

    <div id="requestResult"></div>
</div>

<br>
<hr>
<br>

<!-- Verify Signature Section -->
<div>
    <h2>Step 2: Verify Signature</h2>

    <p><strong>Note:</strong> Use the following command to generate your signature:</p>
    <code>cardano-signer sign --secret-key calidus.skey --data-hex "&lt;unhashed_nonce_value&gt;"</code><br><br>

    <label>Nonce (from previous step):</label><br>
    <input type="text" id="nonce" placeholder="Enter Nonce"><br><br>

    <label>Calidus Key (auto-filled if found):</label><br>
    <input type="text" id="verifyCalidusKey" placeholder="Enter Calidus Key"><br><br>

    <label>Signature (from CLI signing):</label><br>
    <input type="text" id="signature" placeholder="Enter Signature"><br><br>

    <button onclick="verifySignature()">Verify Signature</button>

    <div id="verifyResult"></div>
</div>

<script>
    async function requestAuth() {
        const poolId = document.getElementById('poolId').value;
        const calidusKey = document.getElementById('calidusKey').value;

        const response = await fetch('http://localhost:3000/request-auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({poolId, calidusKey})
        });

        const result = await response.json();
        if (result.nonce) {
            document.getElementById('requestResult').innerHTML = `
                    <strong>Nonce (to sign with cardano-signer):</strong> ${result.nonce}<br>
                    <strong>Message:</strong> ${result.message}<br>
                    <strong>Pool ID:</strong> ${result.poolId || 'N/A'}<br>
                    <strong>Calidus ID:</strong> ${result.calidusId || 'N/A'}
                `;

            // Automatically transfer the values to the verify form
            document.getElementById('nonce').value = result.nonce;
            document.getElementById('verifyCalidusKey').value = result.calidusId || calidusKey;
        } else {
            document.getElementById('requestResult').innerText = JSON.stringify(result, null, 2);
        }
    }

    async function verifySignature() {
        const nonce = document.getElementById('nonce').value;
        const calidusKey = document.getElementById('verifyCalidusKey').value;
        const signature = document.getElementById('signature').value;

        const response = await fetch('http://localhost:3000/verify-signature', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({nonce, calidusKey, signature})
        });

        const result = await response.json();
        document.getElementById('verifyResult').innerText = JSON.stringify(result, null, 2);
    }
</script>
</body>
</html>
